services:
  qdrant:
    image: qdrant/qdrant
    volumes:
      - ./qdrant_storage:/qdrant/storage
    networks:
      - net

  ingestion:
    build: .
    depends_on:
      - qdrant
    environment:
      # Connection to local Qdrant service
      QDRANT_URL: "http://qdrant:6333"
      # Ollama embedding endpoint (on server, accessed via tunnel)
      OLLAMA_URL: "http://host.docker.internal:11434"
      # Credentials for the tunnel
      AAAS_TOKEN: "client_1:pass_123"
      # Where the server is listening
      AAAS_TUNNEL_HOST: "host.docker.internal:9090"
      # Expose Qdrant to server via reverse tunnel
      REMOTE_PORT: "6333"
    volumes:
      - ./docs:/app/documents
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - net
    command: /app/start.sh

volumes:
  qdrant_storage:

networks:
  net:
    driver: bridge
